/* globules.io MongOGX v1.2.0 Apache2 */
if("undefined"==typeof OGX)var OGX={};OGX.MongogxCollection=class{constructor(a,b){this.name=a,this.data=b,this._initDocuments()}get collection(){let b=[];for(let c in this.data)b.push(this.data);return b}insert(){return 0<arguments.length?this.insertMany.apply(null,arguments):this.insertOne(arguments[0])}insertOne(a){if(!a.hasOwnProperty("_id"))a._id=this._genMongoId();else if(!this._isMongoId(a._id))return!1;return this.data[a._id]=a,a._id}insertMany(){let b,c=[];for(let d in arguments)b=insertOne(d),c.push(b);return c}update(a,b){return this.updateOne(a,b)}updateOne(a,b){let c=this.find(a,1);return!!c&&this._update(c,b)}updateMany(){let a=this.find(__query);return!!a&&this._update(a,__update)}replaceOne(a,b){b._id=this._genMongoId();let c=this.find(a,1);if(c)for(let a in c)return this.data[b._id]=b,delete this.data[a],!0;return!1}deleteOne(a){let b=this.find(a,1);if(b)for(let a in b)return delete this.data[a],!0;return!1}deleteMany(a){let b=0,c=this.find(a);if(c)for(let a in c)delete this.data[a],b++;return b}remove(){this.data={}}find(a,b){"undefined"==typeof b?b=0:null;let c,d,e,f,g={},h=0,i=this.data;for(let j in a.hasOwnProperty("_id")&&this._isMongoId(a._id)&&this.data.hasOwnProperty(a._id)&&(i={},i[a._id]=this.data[a._id]),i){for(let b in c=!0,f=!1,a){if(e=i[j],d=b.split("."),1<d.length)for(;0<d.length;){if(!e.hasOwnProperty(d[0])){c=!1;break}if(c&&(e=e[d[0]],d.shift(),Array.isArray(e)))if(!isNaN(+d[0]))e=e[d[0]],d.shift();else if(0!==d.length){for(let g=0;g<e.length;g++)if(c=this._handleOp(e[g][d[0]],a[b]),c){f=!0;break}break}else if(c=this._handleOp(e,a[b]),c){f=!0;break}if(!c)break}else e.hasOwnProperty(b)?e=e[b]:c=!1;if(c&&!f&&(c=this._handleOp(e,a[b]),!c))break}if(c&&(g[j]=i[j],h++,0<b&&b===h))return g}return g}toJSON(){let b=[];for(let c in this.data)b.push(this.data[c]);return b}_handleOp(a,b){let c,d=!0;if("object"==typeof b){for(let e in b){if("$"===e.substr(0,1))switch(c=e.substr(1),c){case"eq":d=a===b[e];break;case"neq":d=a!==b[e];break;case"gt":d=a>b[e];break;case"gte":d=a>=b[e];break;case"lt":d=a<b[e];break;case"lte":d=a<=b[e];break;case"in":if(Array.isArray(b[e]))for(let c=0;c<b[e].length&&(d=-1!==a.indexOf(b[e][c]),!d);c++);else d=-1!==a.indexOf(b[e]);break;case"text":d=-1!==a.indexOf(b[e]);break;case"nin":if(Array.isArray(b[e]))for(let c=0;c<b[e].length&&(d=-1===a.indexOf(b[e][c]),!!d);c++);else d=-1===a.indexOf(b[e]);break;case"regex":d=b[e].match(a);break;case"mod":d=a%b[e][0]===b[e][1];break;case"all":if(Array.isArray(b[e])&&Array.isArray(a)){let c;d=!0;for(let f=0;f<b[e].length;f++){c=!1;for(let d=0;d<a.length;d++)if(b[e][f]===a[d]){c=!0;break}if(!c){d=!1;break}}}break;case"size":d=b[e].length==a.length;}if(!d)break}return d}return!(a!==b)}_update(__collection,__update){let match=0;for(let _id in __collection){let oper,ev,ev2,pre,pro;for(let op in __update)if("$"===op.substr(0,1))for(let prop in oper=op.substr(1),__update[op])switch(oper){case"set":ev=eval("this.data[_id]."+prop+"="+__update[op][prop]),"undefined"!=typeof ev&&match++;break;case"unset":ev=eval("delete this.data[_id]."+prop),"undefined"!=typeof ev&&match++;break;case"inc":ev=eval("this.data[_id]."+prop+"+="+__update[op][prop]),"undefined"!=typeof ev&&match++;break;case"min":ev=eval("this.data[_id]."+prop),"undefined"!=typeof ev&&ev>__update[op][prop]&&(ev=eval("this.data[_id]."+prop+"="+__update[op][prop]),"undefined"!=typeof ev&&match++);case"max":ev=eval("this.data[_id]."+prop),"undefined"!=typeof ev&&ev<__update[op][prop]&&(ev=eval("this.data[_id]."+prop+"="+__update[op][prop]),"undefined"!=typeof ev&&match++);break;case"mul":ev=eval("this.data[_id]."+prop+"*="+__update[op][prop]),"undefined"!=typeof ev&&match++;break;case"rename":let pos=prop.lastIndexOf(".");-1===pos?(pre="",pro=prop):(pre=prop.substr(0,pos+1),pro=prop.split(".").pop()),ev=eval("this.data[_id]."+pre+__update[op][prop]+"=this.data[_id]."+pre+pro),ev2=eval("delete this.data[_id]."+pre+pro),"undefined"!=typeof ev&&match++;}}return match}_initDocuments(){let b={};for(let c in this.data)b[this.data[c]._id]=this.data[c];this.data=b}_genMongoId(){var a=Math.floor;let b=a(new Date().getTime()/1e3).toString(16);for(;24>b.length;)b+=a(10*Math.random()).toString();return b}_isMongoId(a){return"string"==typeof a&&a.match(/[a-z0-9]{24}/g)}};if("undefined"==typeof OGX)var OGX={};OGX.Mongogx=class{constructor(b,c,d){this.data_default={db:{mongogx:{}}},this.database=null,this.data=null,this.options=null;let e={storage:OGX.Mongogx.LOCAL_STORAGE,write_concern:{mode:OGX.Mongogx.WRITE_DIRECT,delay:5},encryption:!1,format:OGX.Mongogx.FORMAT_ARRAY,callback:function(){}};for(var f in"undefined"==typeof d&&(d={}),e)d.hasOwnProperty(f)||(d[f]=e[f]);this.options=d,this._loadData(b,c)}static get LOCAL_STORAGE(){return"localStorage"}static get SESSION_STORAGE(){return"sessionStorage"}static get APP_STORAGE(){return"appStorage"}static get WRITE_DIRECT(){return"writeDirect"}static get ENCRYPTION_AES(){return"AES"}static get FORMAT_OBJECT(){return 0}static get FORMAT_ARRAY(){return 1}setDatabase(a){return!!this.data.db.hasOwnProperty(a)&&(this.database=a,!0)}getDatabases(){let b=[];for(let c in this.data.db)b.push(c);return b}createDatabase(a){return!this.data.db.hasOwnProperty(a)&&(this.data.db[a]=new OGX.MongogxDatabase(a,{}),this._write(),!0)}deleteDatabase(a){return!!this.data.db.hasOwnProperty(a)&&(delete this.data.db[a],this._write(),!0)}setCollection(a){return!!this._dbSet()&&this.data.db[this.database].setCollection(a)}getCollection(a){return"undefined"==typeof a&&this._isSet()&&(a=this.data.db[this.database].collection),!!(this._dbSet()&&this.data.db[this.database].hasCollection(a))&&this.data.db[this.database].getCollection(a).collection}createCollection(a){if(this._dbSet()){let b=this.data.db[this.database].createCollection(a);if(b)return this.data.db[this.database].collections[a]=b,!0}return!1}deleteCollection(a){if(!this.database)return!1;let b=this.data.db[this.database].deleteCollection(a);return!!b&&(this._write(),b)}insert(){return 1<arguments.length?this.insertMany.apply(null,arguments):this.insertOne(arguments[0])}insertOne(a){if(this._isSet()){let b=this.data.db[this.database].getCollection().insertOne(a);if(b)return this._write(),b}return!1}insertMany(){if(this._isSet()){let a=this.data.db[this.database].getCollection().insertMany.apply(null,parameters);if(a)return this._write(),a}return!1}update(a,b){if(this._isSet()){let c=this.data.db[this.database].getCollection().update(a,b);if(c)return this._write(),c}return!1}updateOne(a,b){if(this._isSet()){let c=this.data.db[this.database].getCollection().updateOne(a,b);if(c)return this._write(),c}return!1}updateMany(a,b){if(this._isSet()){let c=this.data.db[this.database].getCollection().updateMany(a,b);if(c)return this._write(),c}return!1}replaceOne(a,b){if(this._isSet()){let c=this.data.db[this.database].getCollection().replaceOne(a,b);if(c)return this._write(),c}return!1}deleteOne(a){if(this._isSet()){let b=this.data.db[this.database].getCollection().deleteOne(a);if(b)return this._write(),b}return!1}deleteMany(a){if(this._isSet()){let b=this.data.db[this.database].getCollection().deleteMany(a);if(b)return this._write(),b}return!1}find(a,b){if(this._isSet()){let c=this.data.db[this.database].getCollection().find(a,b);return this.options.format&&(c=this._objToArr(c)),c}return!1}_objToArr(b){let c=[];for(let d in b)b.hasOwnProperty(d)&&c.push(b[d]);return c}_getStorage(a){let b;return a===OGX.Mongogx.LOCAL_STORAGE?b=localStorage:a===OGX.Mongogx.SESSION_STORAGE?b=sessionStorage:void 0,b}_loadData(a,b){let c=this;switch(this.options.storage){case OGX.Mongogx.APP_STORAGE:this._readFile("mongogx.data",function(d){c.options.encryption&&(d=c._decrypt(d)),c.data=JSON.parse(d),c._write(),c._initDatabases(a,b)});break;case OGX.Mongogx.LOCAL_STORAGE:case OGX.Mongogx.SESSION_STORAGE:let d=this._getStorage(this.options.storage),e=d.getItem("mongogx");e?(c.options.encryption&&(e=c._decrypt(e)),this.data=JSON.parse(e)):(this.data=JSON.parse(JSON.stringify(this.data_default)),this._write()),this._initDatabases(a,b);}}_initDatabases(a,b){for(let c in this.data.db)this.data.db[c]=new OGX.MongogxDatabase(c,this.data.db[c]);if("undefined"!=typeof a&&a&&(this.data.db.hasOwnProperty(a)||this.createDatabase(a),this.setDatabase(a),"undefined"!=typeof b)){let a=this.getCollection(b);a||this.createCollection(b),this.setCollection(b)}this.options.storage===OGX.Mongogx.APP_STORAGE&&this.options.callback()}_write(){let a=this,b=JSON.stringify(a.data);switch(this.options.encryption&&(b=this._encrypt(b)),this.options.storage){case OGX.Mongogx.APP_STORAGE:setTimeout(function(){a._writeFile("mongogx.data",b)},a.options.write_concern.delay);break;case OGX.Mongogx.LOCAL_STORAGE:case OGX.Mongogx.SESSION_STORAGE:let c=this._getStorage(this.options.storage);setTimeout(function(){c.setItem("mongogx",b)},a.options.write_concern.delay);}}_encrypt(a){switch(this.options.encryption.scheme){case OGX.Mongogx.ENCRYPTION_AES:return this._encryptAES(a);}}_encryptAES(a){let b=CryptoJS.AES.encrypt(a,this.options.encryption.key,{mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return b.toString()}_decrypt(a){switch(this.options.encryption.scheme){case OGX.Mongogx.ENCRYPTION_AES:return this._decryptAES(a);}}_decryptAES(a){let b=CryptoJS.AES.decrypt(a,this.options.encryption.key,{mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7});return b.toString(CryptoJS.enc.Utf8)}_dbSet(){return this.database&&this.data.db.hasOwnProperty(this.database)}_isSet(){return this._dbSet()&&null!==this.data.db[this.database].collection}_writeFile(a,b,c){this.options.encryption&&(b=this._encrypt(b)),window.resolveLocalFileSystemURL(cordova.file.dataDirectory,function(d){d.getFile(a,{create:!0},function(a){a.createWriter(function(a){let d=new Blob([b],{type:"text/plain"});a.write(d),"undefined"!=typeof c&&c()})})})}_readFile(a,b){let c=this;window.resolveLocalFileSystemURL(cordova.file.dataDirectory+a,function(a){a.file(function(a){let d=new FileReader;d.onloadend=function(){let a=this.result;c.options.encryption&&(a=c._decrypt(a)),b(a)},d.readAsText(a)})},()=>this._onReadFail())}_onReadFail(a){this.data=JSON.parse(JSON.stringify(this.data_default)),this._writeFile("mongogx.data",JSON.stringify(this.data)),this._initDatabases()}};if("undefined"==typeof OGX)var OGX={};OGX.MongogxDatabase=class{constructor(b,c,d){this.name=b,this.collection=null,this.collections=c,this._initCollections(),"undefined"!=typeof d&&this.setCollection(d)}setCollection(b){return!!this.collections.hasOwnProperty(b)&&(this.collection=b,!0)}getCollections(){let b=[];for(let c in this.collections)b.push(c);return b}getCollection(b){return"undefined"==typeof b&&this.collection&&(b=this.collection),!!this.collections.hasOwnProperty(b)&&this.collections[b]}createCollection(b){return!this.collections.hasOwnProperty(b)&&(this.collections[b]=new OGX.MongogxCollection(b,{}),this.collections[b])}deleteCollection(b){return!!this.collections.hasOwnProperty(b)&&void delete this.collections[a]}hasCollection(b){return this.collections.hasOwnProperty(b)}_initCollections(){for(let b in this.collections)this.collections[b]=new OGX.MongogxCollection(b,this.collections[b])}toJSON(){return this.collections}};